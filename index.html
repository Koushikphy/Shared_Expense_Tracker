<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Shared Expense Tracker </title>
    <link rel="stylesheet" href="https://bossanova.uk/jsuites/v3/jsuites.css" type="text/css" />
    <link rel="stylesheet" href="https://bossanova.uk/jexcel/v4/jexcel.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://bossanova.uk/jsuites/v3/jsuites.js"></script>
    <script src="https://bossanova.uk/jexcel/v4/jexcel.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <link href="style.css" rel="stylesheet">
    <script src="./utils.js"></script>
</head>
<body>
    <div id="header">
        <div class="headerName">Shared Expense Tracker</div>
        <div class='pages'>
            <div onclick="selectPage(0)">Home </div>
            <div onclick="selectPage(1)">Analytics</div>
            <div onclick="selectPage(2)">Settings</div>
        </div>
    </div>
    <div id="root">
        <div id="summery">
            <div class="SpentSum">
                <div class="SpentHead">Spent By</div>
                <div id ='spendStat'></div>
            </div>

            <div class="SpentSum">
                <div class="SpentHead">Total Owe</div>
                <div id ='totOweStat'></div>
            </div>

            <div class="SpentSum">
                <div class="SpentHead">Net Owe</div>
                <div id ='oweStat'></div>
            </div>
        </div>
        <div id="sheet"> </div>
    </div>

    <div id="analysis">
       <div id='expenseByDate'></div>
       <div id='expenseByUser'></div><div id='expenseByCategory'></div>
    </div>
    <div id="settings">
        <div id="container">
            <div class="sLabel">User List</div>
            <textarea type="text" name="" id="uList" class="sInput" placeholder="Provide userlist with comma" spellcheck="false"></textarea>
            <div class="sLabel">Category List</div>
            <textarea type="text" name="" id="cList" class="sInput" placeholder="Provide categories with comma" spellcheck="false"></textarea>
            <button class="sButtons" onclick="updateLists()">Update</button>
            <!-- <input type="file" name="" id="dummy" style="display:none;" onchange="importData(event)"> -->
            <button class="sButtons" onclick="importData()">Import Data</button>
            <button class="sButtons" onclick="exportData()">Export Data</button>
        </div>
    </div>

<script>

    const expenseByDate     = document.getElementById('expenseByDate');
    const expenseByUser     = document.getElementById('expenseByUser');
    const expenseByCategory = document.getElementById('expenseByCategory');
    var currentEditabele=undefined, saved=false, users, categories, records, myTable;



    window.onload = () =>{
        Plotly.newPlot(expenseByDate, new Array(4).fill(0).map(u=>clone(lineConfig)),layout, config )
        Plotly.newPlot(expenseByUser, [pieConfig],layout2, config );
        Plotly.newPlot(expenseByCategory, [pieConfig],layout2, config );
        loadDataFromStorage()
        startTable()

        updateListDOMs()
        updateTable()
        if(records.length) updateRecords()
    }

    window.onbeforeunload = () =>{
        if(!saved) alert('Save first')
    }



    function loadDataFromStorage(){
        [users, categories, records] = ['users', 'categories', 'records'].map(e=>{
            let uu = localStorage.getItem(e)
            return uu!=null? JSON.parse(uu) : []
        })


    }


    function saveDataToStorage(){
        ['users', 'categories', 'records'].forEach(e=>{
            localStorage.setItem(e, JSON.stringify(window[e]))
        })

    }


    function updateListDOMs(){
        $('#uList').val(users.join(','))
        $('#cList').val(categories.join(','))
        myTable.options.columns[1].source = users
        myTable.options.columns[3].source = categories
        myTable.options.columns[5].source = ['All',...users]
    }


    function updateLists(){
        users = $('#uList').val().split(',').map(e=>e.trim())
        categories = $('#cList').val().split(',').map(e=>e.trim())
        saveDataToStorage()
        updateListDOMs()
        selectPage(0)
    }


    function calculateShares(){

        var spent  = Object.fromEntries(users.map(i=>[i,0]))
        var totOwe = Object.fromEntries(users.map(i=>[i,0]))
        var netOwe = Object.fromEntries(users.map(i=>[i,0]))

        for(let rec of records){
            let amount = parseFloat(rec.amount);
            let shareBy = rec.shareBy.split(';');
            shareBy = shareBy.length==1 && shareBy[0]=='All' ? users : shareBy;
            let sAmount = amount/shareBy.length;
            // spent calculation
            spent[rec.person] += amount
            //owe calculation
            for(let pp of shareBy) {
                netOwe[pp] += sAmount
                totOwe[pp] += sAmount
            }
            netOwe[rec.person] -= amount
        }

        $("#spendStat").html(users.map(i=>`
        <div class="SpentDetails">
            <div class="sChildName"> ${i} </div>
            <div class="sChildAmount"> ${spent[i].toFixed(2)}</div>
        </div>
        `).join(''))

        $("#oweStat").html(users.map(i=>`
        <div class="SpentDetails">
            <div class="sChildName"> ${i} </div>
            <div class="sChildAmount"> ${netOwe[i].toFixed(2)} </div>
        </div>
        `).join(''))

        $("#totOweStat").html(users.map(i=>`
        <div class="SpentDetails">
            <div class="sChildName"> ${i} </div>
            <div class="sChildAmount"> ${totOwe[i].toFixed(2)} </div>
        </div>
        `).join(''))
    }


    function updateRecords(){
        calculateShares()
        saveDataToStorage()
        updatePlot()
    }



    function updatePlot(){
        var tmp = transpose(
                uniqueDates(records.map(i=>i.date)).map(dt=> 
                    [dt, ...users.map(u=>sum(records.filter(i=>i.date==dt).filter(i=>i.person==u).map(i=>parseFloat(i.amount))))]
                ).map(arr=>[...arr, sum(arr.slice(1))])
            )

        Plotly.restyle(expenseByDate, {
            x : [tmp[0]],
            y : tmp.splice(1),
            name: [...users,'Total']
        })

        var tmp = transpose(users.map(u=>[u, sum(records.filter(i=>i.person==u).map(i=>parseFloat(i.amount)))]))

        Plotly.restyle(expenseByUser,{
            values: [tmp[1]],
            labels: [tmp[0]],
        })

        var tmp = transpose(categories.map(u=>[u, sum(records.filter(i=>i.category==u).map(i=>parseFloat(i.amount)))])
        )
        Plotly.restyle(expenseByCategory,{
            values: [tmp[1]],
            labels: [tmp[0]],
        })

    }


    function importData(){

        alert('This will remove all existing records');

        const fileInput = document.createElement("input")
        fileInput.type='file'
        fileInput.style.display='none'
        fileInput.onchange=(ev)=>{
            var file = ev.target.files[0]
            if(!file) return

            var reader = new FileReader();
            reader.readAsText(file,'UTF-8');

            reader.onload = (event) => {
                let content = JSON.parse(event.target.result); 
                users = content.users
                categories = content.categories
                records = content.records
                updateListDOMs()
                updateRecords()
                updateTable()
                selectPage(0)
            }
        }
        document.body.appendChild(fileInput)
        fileInput.click()
        fileInput.remove()
    }


    function exportData(){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([JSON.stringify({users,categories,records},null,4)], {type: "text/plain"}));
        a.setAttribute("download", "data.json");
        document.body.appendChild(a);
        a.click();
        a.remove()
    }


    function selectPage(m){
        $("#root,#analysis,#settings").hide()
        $(["#root","#analysis","#settings"][m]).show()
        window.dispatchEvent(new Event('resize'));
    }


    function startTable(){
        myTable = jexcel(document.getElementById('sheet'), {
            columns: [
                {type:'calendar',title:'date', options: { format:'DD-MM-YYYY', resetButton:false, fullscreen:true }},
                {type:'dropdown',title:'Spent By', autocomplete:true, multiple:false, source: users},
                {type:'text',    title:'Item' },
                {type:'dropdown',title:'Category', autocomplete:true, multiple:false, source: categories},
                {type:'numeric', title:'Amount' },
                {type:'dropdown',title:'Shared By',autocomplete:true, multiple:true,  source : ['All',...users]},
            ],
            // tableOverflow:true,
            defaultColWidth         : (document.getElementById('sheet').offsetWidth-55)/6,
            csvFileName             : 'data',
            csvDelimiter            : ',',
            allowRenameColumn       : false,
            search                  : true,
            pagination              : 15,
            csvHeaders              : true,
            minSpareRows            : true,
            includeHeadersOnDownload: true,
            columnDrag              : false,
            rowDrag                 : false,
            allowInsertColumn       : false,
            allowDeleteColumn       : false,
            allowRenameColumn       : false,
            wordWrap                : true,
            selectionCopy           : false,
            onchange                : ()=>{
                let tt = myTable.getData().filter(e=>!e.includes(''))
                if(!isEqual(tt,records.map(Object.values))) {
                    records = tt.map(e=>Object.fromEntries(transpose([['date','person','item','category','amount','shareBy'],e])))
                    updateRecords()
                }
            }
        });
    }




    function updateTable(){
        if(records.length) myTable.setData(records.map(e=>[e.date, e.person, e.item, e.category, e.amount, e.shareBy]))
    }


</script>
</body>
</html>